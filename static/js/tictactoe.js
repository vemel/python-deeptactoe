// Generated by CoffeeScript 1.4.0
(function() {

  $(function() {
    var $board, $info, $start, $status, $team, CROSS, NOUGHT, redrawBoard, socket, team, turnTeam, updateText;
    socket = io.connect(appConfig.httpHost);
    team = 0;
    turnTeam = 0;
    CROSS = 1;
    NOUGHT = 2;
    $start = $('#start-game');
    $team = $('#team');
    $info = $('#info');
    $board = $('#board > table');
    $status = $('#status');
    $start.hide();
    updateText = function($block, message) {
      $block.hide();
      $block.html(message);
      return $block.fadeIn();
    };
    redrawBoard = function(board) {
      var html, i, j, styleClass, symbol, _i, _j, _ref, _ref1;
      html = '';
      for (i = _i = 0, _ref = board.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
        html += '<tr>';
        for (j = _j = 0, _ref1 = board.length; 0 <= _ref1 ? _j < _ref1 : _j > _ref1; j = 0 <= _ref1 ? ++_j : --_j) {
          styleClass = '';
          symbol = '';
          if (board[i][j] === CROSS) {
            styleClass = 'cross';
            symbol = 'X';
          } else if (board[i][j] === NOUGHT) {
            styleClass = 'nought';
            symbol = 'O';
          }
          html += "<td --data-x=\"" + i + "\" --data-y=\"" + j + "\" class=\"" + styleClass + "\">\n  " + symbol + "\n</td>";
        }
        html += '</tr>';
      }
      return $board.html(html);
    };
    $status.text('Connecting to server...');
    socket.on('connect', function() {
      $start.show();
      updateText($status, 'Connection established');
      return ($('#board')).on('click', 'td', function() {
        var $this;
        $this = $(this);
        if (team !== turnTeam || ($this.attr('class')) !== '') {
          return;
        }
        return socket.emit('turn', {
          x: $this.attr('--data-x'),
          y: $this.attr('--data-y')
        });
      });
    });
    socket.on('waitingForOpponent', function() {
      return updateText($status, 'Waiting for opponent...');
    });
    socket.on('gameStarted', function(data) {
      team = data.team;
      updateText($team, "You are playing for " + (team === CROSS ? 'X' : 'O'));
      return updateText($status, 'Game started');
    });
    socket.on('gameStateChanged', function(data) {
      turnTeam = data.currentTeam;
      redrawBoard(data.board);
      return updateText($info, "Now is " + (team === turnTeam ? 'your turn' : 'your opponent\'s turn'));
    });
    socket.on('gameFinished', function(data) {
      var message;
      turnTeam = 0;
      if (data.reason === 'opponentLeaving' && data.team !== team) {
        $info.text('');
        $team.text('');
        return updateText($status, '<span class="bad">Sorry, but your opponent left the game. Try to start new game</span>');
      } else if (data.reason === 'complete') {
        if (data.winner === team) {
          message = '<span class="good">You win! ^^</span>';
        } else if (data.winner === -1) {
          message = 'Draw! -_-';
        } else {
          message = '<span class="bad">You lose! ;_;</span>';
        }
        redrawBoard(data.board);
        return updateText($info, message);
      }
    });
    return $start.click(function() {
      $info.text('');
      $team.text('');
      socket.emit('startGame');
      updateText($status, 'Trying to create new game...');
      return false;
    });
  });

}).call(this);
